<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recargo por Jornada Nocturna</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--accent:#06b6d4;--muted:#475569;--glass:rgba(2,6,23,0.03)}
    *{box-sizing:border-box;font-family:Inter, system-ui, Arial, Helvetica, sans-serif}
    body{margin:0;background:linear-gradient(180deg,#f8fafc 0%, #eef8fb 100%);color:#0b3140;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:900px;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(2,6,23,0.6);}
    header{display:flex;gap:16px;align-items:center}
    header h1{font-size:1.15rem;margin:0}
  .grid{display:grid;grid-template-columns:1fr 320px;gap:18px;margin-top:16px;align-items:start}
    .panel{background:var(--glass);padding:14px;border-radius:10px}
    /* aside panel sticky + slide on scroll */
    aside.panel{position:sticky;top:22px;transition:transform 260ms cubic-bezier(.2,.9,.2,1);will-change:transform;overflow:auto;max-height:calc(100vh - 120px)}
    @media(max-width:880px){
      aside.panel{position:static;transform:none;max-height:none;overflow:visible}
    }
    label{display:block;font-size:0.9rem;margin-bottom:6px;color:var(--muted)}
    input,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:10px;color:#042027;font-weight:600;cursor:pointer}
  .result{background:linear-gradient(90deg, rgba(103,232,249,0.08), rgba(125,211,252,0.03));padding:12px;border-radius:8px;margin-top:10px}
    .warn{background:#3b2a18;color:#fff;padding:8px;border-radius:6px;font-size:0.9rem}
    .muted-note{font-size:0.85rem;color:var(--muted);margin-top:8px}
    footer{margin-top:14px;font-size:0.85rem;color:var(--muted)}
    pre{white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
    option{background:var(--card);color:inherit}
    @media(max-width:880px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="card">
    <header>
  <div style="width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#22d3ee,#7dd3fc);display:flex;align-items:center;justify-content:center;font-weight:700;color:#042027">N</div>
      <div>
        <h1>Calculadora de la Jornada Nocturna — Recargo 25%</h1>
        <div class="muted-note">Herramienta para calcular el valor de la hora nocturna, las horas extras nocturnas y la remuneración total según el Código de Trabajo de El Salvador (recargo 25%).</div>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <label for="mode">¿Cómo lo quieres calcular?</label>
        <select id="mode">
          <option value="hourly">Por tarifa por hora (HD)</option>
          <option value="monthly">Por salario mensual</option>
        </select>

        <div id="hourlyInputs" style="margin-top:12px">
          <label>¿Cuánto ganas por hora?</label>
          <input id="hd" type="number" step="0.01" min="0" value="2.50" />
          <div style="height:8px"></div>
          <label>¿Cual es la jornada laboral por día?</label>
          <input id="hoursPerDayHourly" type="number" step="0.1" min="1" value="8" />
        </div>

        <div id="monthlyInputs" style="margin-top:12px;display:none">
          <label>¿Cuál es tu salario básico mensual (SBM)?</label>
          <input id="sbm" type="number" step="0.01" min="0" value="600" />
          <div style="height:8px"></div>
          <label>Horas ordinarias por día (contrato)</label>
          <input id="hoursPerDay" type="number" step="0.1" min="1" value="8" />
        </div>

        <div style="margin-top:12px">
          <label for="hoursMode">¿Cómo quieres ingresar las horas?</label>
          <select id="hoursMode">
            <option value="period">Por día (horas trabajadas en la jornada)</option>
            <option value="week">Por semana (total de horas nocturnas trabajadas)</option>
          </select>
        </div>

        <div id="periodHours" style="margin-top:12px">
          <label>Horas nocturnas trabajadas</label>
          <input id="nightHours" type="number" step="0.01" min="0" value="7" />
          <div class="muted-note">La jornada nocturna diaria no debe exceder 7 horas. Las horas adicionales se pagan al doble.</div>
        </div>

        <div id="weekHours" style="margin-top:12px;display:none">
          <label>Total de horas nocturnas en la semana</label>
          <input id="nightHoursWeek" type="number" step="0.1" min="0" placeholder="ej. 39" />
          <div class="muted-note">La jornada nocturna semanal no debe exceder 39 horas. Las horas adicionales se pagan al doble.</div>
        </div>

        <div style="margin-top:12px" class="row">
          <button id="calc">Calcular</button>
          <button id="reset" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit">Reset</button>
        </div>

        <div id="warnings" style="margin-top:10px"></div>

        <div class="result" id="resultBox" style="display:none">
          <div id="r1"></div>
          <div id="r2" style="margin-top:8px"></div>
          <pre id="formula" style="margin-top:8px"></pre>
        </div>

      </section>

      <aside class="panel">
        <h3>Resumen legal</h3>
        <p class="muted-note">Artículo 161 — Hora nocturna: 19:00 a 06:00. La jornada nocturna máxima es de 7 horas diarias o 39 horas semanales. Las horas excedentes se consideran extraordinarias y se pagan con un recargo del 100% sobre la hora nocturna.</p>
        <h4>Fórmulas</h4>
        <ul>
          <li><strong>HN</strong> = HD × 1.25 (valor de la hora nocturna)</li>
          <li><strong>HEN</strong> = HN × 2 (hora extra nocturna, pagada al doble)</li>
          <li>Si tienes salario mensual: SBD = SBM / 30 → HD = SBD / 7 (horas por día)</li>
        </ul>

        <footer>
          Creadores: <br>
          Francisco Javier Lemus Cruz<br>
          Rony Josue Sorto Villalta
        </footer>
      </aside>
    </div>
  </div>

  <script>
    const mode = document.getElementById('mode');
    const hourlyInputs = document.getElementById('hourlyInputs');
    const monthlyInputs = document.getElementById('monthlyInputs');
    const hdInput = document.getElementById('hd');
    const sbmInput = document.getElementById('sbm');
    const hoursPerDay = document.getElementById('hoursPerDay');
    const hoursPerDayHourly = document.getElementById('hoursPerDayHourly');
    const nightHours = document.getElementById('nightHours');
    const nightHoursWeek = document.getElementById('nightHoursWeek');
    const hoursMode = document.getElementById('hoursMode');
    const periodHours = document.getElementById('periodHours');
    const weekHours = document.getElementById('weekHours');
    const calcBtn = document.getElementById('calc');
    const resetBtn = document.getElementById('reset');
    const resultBox = document.getElementById('resultBox');
    const r1 = document.getElementById('r1');
    const r2 = document.getElementById('r2');
    const formula = document.getElementById('formula');
    const warnings = document.getElementById('warnings');
  const asidePanel = document.querySelector('aside.panel');

    function showMode(){
      if(mode.value === 'hourly'){
        hourlyInputs.style.display = '';
        monthlyInputs.style.display = 'none';
      } else {
        hourlyInputs.style.display = 'none';
        monthlyInputs.style.display = '';
      }
    }

    mode.addEventListener('change', showMode);
    showMode();

    function showHoursMode(){
      if(hoursMode.value === 'period'){
        periodHours.style.display = '';
        weekHours.style.display = 'none';
      } else {
        periodHours.style.display = 'none';
        weekHours.style.display = '';
      }
    }

    hoursMode.addEventListener('change', showHoursMode);
    showHoursMode();

    // Truncate a number to `decimals` places without rounding
    function truncateTo(n, decimals){
      const num = Number(n) || 0;
      const factor = Math.pow(10, decimals);
      return Math.trunc(num * factor) / factor;
    }

    // Format currency using truncation (no rounding) to avoid approximations like 3.125 -> 3.13
    function currency(n){
      return '$' + truncateTo(n, 2).toFixed(2);
    }

    calcBtn.addEventListener('click', ()=>{
      warnings.innerHTML = '';
      resultBox.style.display = 'none';

      const nh = parseFloat(nightHours.value) || 0;
      const nhWeek = parseFloat(nightHoursWeek.value);
      const selectedHoursMode = hoursMode.value;

      let hd = 0;
      let sbn = 0;
      let sbm = parseFloat(sbmInput.value) || 0;

      let estimatedMonthlyNoRecargo = 0;
      if(mode.value === 'hourly'){
        hd = parseFloat(hdInput.value) || 0;
        const hpdayH = parseFloat(hoursPerDayHourly.value) || 7;
        estimatedMonthlyNoRecargo = hd * hpdayH * 30; // estimación mensual sin recargo
        sbn = estimatedMonthlyNoRecargo * 1.25; // salario mensual estimado con recargo 25%
      } else {
        const hpday = parseFloat(hoursPerDay.value) || 7;
        const sbd = sbm / 30;
        hd = sbd / hpday;
        sbn = sbm * 1.25;
      }

      const hn = hd * 1.25;

      // Determinar horas regulares y extras
      let regularHours = 0;
      let extraHours = 0;
      if(selectedHoursMode === 'period'){
        regularHours = Math.min(nh, 7);
        extraHours = Math.max(0, nh - 7);
      } else {
        const weekH = isNaN(nhWeek) ? 0 : nhWeek;
        regularHours = Math.min(weekH, 39);
        extraHours = Math.max(0, weekH - 39);
      }

      // Aplicar truncamiento a HN y a la hora extra (HEN) antes de calcular pagos
      const hnTrunc = truncateTo(hn, 2);
      const henTrunc = truncateTo(hn * 2, 2);

      // Calcular pagos usando las tarifas truncadas y truncar los montos intermedios a 2 decimales
      const regularPayRaw = hnTrunc * regularHours;
      const regularPay = truncateTo(regularPayRaw, 2);

      const overtimePayRaw = henTrunc * extraHours;
      const overtimePay = truncateTo(overtimePayRaw, 2);

      const totalNight = truncateTo(regularPay + overtimePay, 2);

      // El salario nocturno proporcional (igual lógica para monthly y hourly)
      let salarioFinal = 0;
      let salarioNocturnoAjustado = 0; // salario mensual nocturno proporcional con recargo
      // base mensual sin recargo: para hourly usamos estimatedMonthlyNoRecargo, para monthly usamos sbm
      const baseMonthlyNoRecargo = mode.value === 'hourly' ? estimatedMonthlyNoRecargo : sbm;
      const hpdayContract = mode.value === 'hourly' ? (parseFloat(hoursPerDayHourly.value) || 8) : (parseFloat(hoursPerDay.value) || 8);

      if(selectedHoursMode === 'period'){
        // solo las primeras 7 horas son parte de la jornada nocturna; el resto son horas extras
        const nhVal = Math.min(nh, 7); // horas nocturnas consideradas para recargo
        const proportion = hpdayContract > 0 ? (nhVal / hpdayContract) : 0;
        salarioNocturnoAjustado = truncateTo(baseMonthlyNoRecargo * proportion * 1.25, 2);
      } else {
        const weekH = isNaN(nhWeek) ? 0 : nhWeek;
        const avgPerDay = weekH / 7; // promedio diario
        const avgConsidered = Math.min(avgPerDay, 7);
        const proportion = hpdayContract > 0 ? (avgConsidered / hpdayContract) : 0;
        salarioNocturnoAjustado = truncateTo(baseMonthlyNoRecargo * proportion * 1.25, 2);
      }

      // salario final incorpora horas extras (si las hay)
      salarioFinal = truncateTo(salarioNocturnoAjustado + overtimePay, 2);

      // Preparar fórmula para mostrar paso a paso
      let formulaText = '';
      if(mode.value === 'monthly'){
        const sbd = truncateTo(sbm / 30, 4);
        const hdFromSbm = truncateTo(sbd / hpdayContract, 4);
        formulaText = `SBD = SBM / 30 = ${currency(sbd)}\nHD = SBD / ${hpdayContract} = ${currency(hdFromSbm)}\n` +
          `Horas nocturnas consideradas (tope 7h) = ${ (selectedHoursMode==='period') ? 'min(' + nh + ',7)' : 'min((' + (nhWeek||0) + '/7),7)'}\n` +
          `Salario nocturno proporcional = SBM × (horas_nocturnas_consideradas/horas_por_día) × 1.25 = ${currency(salarioNocturnoAjustado)}`;
      } else {
        // hourly: mostrar cálculo proporcional desde la base estimada
        const hpdayH = parseFloat(hoursPerDayHourly.value) || 8;
        formulaText = `Base mensual (estimada) = HD × ${hpdayH} × 30 = ${currency(estimatedMonthlyNoRecargo)}\n` +
          `Salario nocturno proporcional = (Base / ${hpdayH} × ${ (selectedHoursMode==='period') ? Math.min(nh,7) : Math.min((nhWeek||0)/7,7) } ) × 1.25 = ${currency(salarioNocturnoAjustado)}`;
      }
      formula.innerText = formulaText;

      const warns = [];
      if(selectedHoursMode === 'period' && nh > 7) warns.push('Excediste las 7 horas diarias permitidas, las adicionales se consideran horas extras.');
      if(selectedHoursMode === 'week' && nhWeek > 39) warns.push('Excediste las 39 horas semanales permitidas, las adicionales se consideran horas extras.');
  if(hd <= 0) warns.push('La remuneración por hora diurna no puede ser cero.');
  if(hn <= 0) warns.push('El valor de la hora nocturna (HN) no puede ser $0.00 — verifica HD o los datos de salario.');

      if(warns.length) warnings.innerHTML = warns.map(w=>'<div class="warn">'+w+'</div>').join('');

      r1.innerHTML = '<strong>Valor hora diurna (HD):</strong> '+currency(hd)+'<br><strong>Valor hora nocturna (HN):</strong> '+currency(hn);

      let tipo = selectedHoursMode === 'week' ? 'semanal' : 'diario';

  r2.innerHTML = '<table style="width:100%;border-collapse:collapse;font-size:0.95rem">'
    // If mode is hourly, show estimated salary without the 25% surcharge
    + (mode.value === 'hourly' ? ('<tr><td style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06)">Salario estimado (sin recargo)</td><td style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:right">' + currency(estimatedMonthlyNoRecargo) + '</td></tr>') : '')
        + '<tr><td style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06)"><strong>Horas regulares</strong></td><td style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:right">' + regularHours + ' h</td></tr>'
        + '<tr><td style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06)">Valor de horas regulares</td><td style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:right">' + currency(regularPay) + '</td></tr>'
        + '<tr><td style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06)"><strong>Horas extras (doble)</strong></td><td style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:right">' + extraHours + ' h</td></tr>'
        + '<tr><td style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06)">Pago por extras</td><td style="padding:8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:right">' + currency(overtimePay) + '</td></tr>'
        + '<tr><td style="padding:8px;border-top:6px solid transparent"><strong>Total a pagar ' + tipo + '</strong></td><td style="padding:8px;border-top:6px solid transparent;text-align:right"><strong>' + currency(totalNight) + '</strong></td></tr>'
        // Mostrar salario nocturno proporcional cuando el modo es monthly
  + ('<tr><td style="padding:8px;border-top:12px solid transparent">Salario mensual nocturno (proporcional, recargo 25%)</td><td style="padding:8px;border-top:12px solid transparent;text-align:right">' + currency(salarioNocturnoAjustado) + '</td></tr>')
        + '<tr><td style="padding:8px;border-top:6px solid transparent">Salario mensual final (con horas extras ' + tipo + ')</td><td style="padding:8px;border-top:6px solid transparent;text-align:right">' + currency(salarioFinal) + '</td></tr>'
        + '</table>';
      resultBox.style.display = '';
    });

    // Bounded slide: the aside panel will follow scroll but never leaves the container
    (function(){
      if(!asidePanel) return;
      let lastY = window.scrollY || window.pageYOffset;
      let ticking = false;
      let currentTranslate = 0;
      let minTranslate = 0; // highest (up) position
      let maxTranslate = 0; // lowest (down) position

      function recalcLimits(){
        // calculate how much the aside can move down without overflowing the card
        const card = document.querySelector('.card');
        if(!card) return;
        const section = document.querySelector('section.panel');
        const sectionRect = section ? section.getBoundingClientRect() : null;
        const headerNote = document.querySelector('header .muted-note');
        const headerNoteRect = headerNote ? headerNote.getBoundingClientRect() : null;

        // Temporarily clear transform to measure the aside's natural position
        const prevTransform = asidePanel.style.transform;
        asidePanel.style.transform = 'none';
        const asideRectNoTrans = asidePanel.getBoundingClientRect();
        // restore previous transform
        asidePanel.style.transform = prevTransform || '';

        // Align aside to sit below the header note (we keep a small gap)
        if(headerNoteRect){
          const gap = 8;
          // Compute a top offset so sticky keeps it below header note
          const newTop = Math.max(8, headerNoteRect.bottom + gap - document.documentElement.clientTop);
          asidePanel.style.top = newTop + 'px';
        } else {
          asidePanel.style.top = '22px';
        }

        // Compute maxTranslate so aside bottom never exceeds section bottom (card/section)
        const sectionH = sectionRect ? sectionRect.height : 0;
        const asideH = asideRectNoTrans.height;
        minTranslate = 0;
        maxTranslate = Math.max(0, sectionH - asideH - 12);

        // reset current translate to 0 if it's out of bounds
        currentTranslate = Math.max(minTranslate, Math.min(maxTranslate, currentTranslate));
        asidePanel.style.transform = `translateY(${currentTranslate}px)`;
      }

      function onScroll(){
        const y = window.scrollY || window.pageYOffset;
        const delta = y - lastY;
        lastY = y;

        if(window.innerWidth <= 880) return;
        if(resultBox.style.display === 'none') return;

        // tentative translate
        currentTranslate = Math.max(minTranslate, Math.min(maxTranslate, currentTranslate + delta));

        // dynamic safety: ensure aside bottom (with current translate) does not pass card bottom
        const card = document.querySelector('.card');
        if(card){
          // measure aside natural position
          const prev = asidePanel.style.transform;
          asidePanel.style.transform = 'none';
          const asideNoTrans = asidePanel.getBoundingClientRect();
          const cardRect = card.getBoundingClientRect();
          asidePanel.style.transform = prev || '';

          const asideBottomWithTranslate = asideNoTrans.bottom + currentTranslate;
          const maxAllowedBottom = cardRect.bottom - 12; // small padding
          if(asideBottomWithTranslate > maxAllowedBottom){
            // reduce translate so bottom aligns with maxAllowedBottom
            const overflow = asideBottomWithTranslate - maxAllowedBottom;
            currentTranslate = Math.max(minTranslate, currentTranslate - overflow);
          }
        }

        asidePanel.style.transform = `translateY(${currentTranslate}px)`;
      }

      window.addEventListener('scroll', ()=>{
        if(!ticking){
          window.requestAnimationFrame(()=>{ onScroll(); ticking = false; });
          ticking = true;
        }
      }, {passive:true});

      window.addEventListener('resize', ()=>{ recalcLimits(); }, {passive:true});
      // recalc after a result is shown
      const origShow = calcBtn.onclick;
      recalcLimits();
      // also recalc when results are made visible inside calc handler by observing resultBox
      const obs = new MutationObserver(()=> recalcLimits());
      obs.observe(resultBox, {attributes:true, childList:true, subtree:true});
    })();

    resetBtn.addEventListener('click', ()=>{
      hdInput.value = '2.50'; sbmInput.value = '600'; hoursPerDay.value = '7'; hoursPerDayHourly.value = '7'; nightHours.value = '5'; nightHoursWeek.value = '';
      warnings.innerHTML = ''; resultBox.style.display = 'none';
    });
  </script>
</body>
</html>
